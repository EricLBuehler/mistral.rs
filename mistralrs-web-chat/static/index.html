<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mistral.rs Chat</title>
  <style>
    :root {
      --accent: #3498db;
      --accent-hov: #1f7ec5;
      --radius: 8px;
      --bg-light      : #f9f9f9;
      --sidebar-bg    : #ffffff;
      --chat-bg       : #ffffff;
      --border-color  : #e0e0e0;
      --text-muted    : #666666;
      --primary       : #3498db;
      --primary-hov   : #2980b9;
    }
    body {
      display: flex;
      font-family: 'Inter', sans-serif;
      margin: 0;
      height: 100vh;
      background: var(--bg-light);
      color: #333;
    }
    /* ----- sidebar ----- */
    #sidebar {
      width: 260px;
      min-width: 260px;
      max-width: 260px;
      flex-shrink: 0;
      flex-grow: 0;
      background: var(--sidebar-bg);
      box-shadow: 2px 0 8px rgba(0,0,0,0.05);
      padding: 1.5rem;
      border-right: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }
    #sidebar h2 { font-size:1.2rem;margin:0 0 0.5rem; }
    #modelSelect, #clearBtn, #newChatBtn, #renameBtn {
      width: 100%;
      box-sizing: border-box;
      font-family: inherit;
    }
    #modelSelect {
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
    }
    #newChatBtn {
      padding: 0.55rem;
      border:none;
      border-radius:var(--radius);
      background:#4caf50;
      color:#fff;
      cursor:pointer;
      transition:background 0.2s;
    }
    #newChatBtn:hover { background:#429846; }
    #clearBtn {
      padding: 0.55rem;
      border:none;
      border-radius:var(--radius);
      background:#ef5350;
      color:#fff;
      cursor:pointer;
      transition:background 0.2s;
    }
    #clearBtn:hover { background:#d84340; }

    /* Rename button styles */
    #renameBtn {
      padding: 0.55rem;
      border: none;
      border-radius: var(--radius);
      background: #ffca28;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
    }
    #renameBtn:hover { background: #ffb300; }

    #chatList{
      list-style:none;
      padding:0;
      margin:0;
      flex:1 1 auto;
      overflow-y:auto;
    }
    #chatList li{
      padding:0.4rem 0.5rem;
      border-radius:var(--radius);
      cursor:pointer;
      user-select:none;
    }
    #chatList li:hover{ background:#f1f1f1; }
    /* ----- main chat area ----- */
    #main {
      flex: 1 1 auto;
      background: var(--chat-bg);
      padding: 1.5rem;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      transition: background 0.2s;
    }
    #log {
      background: var(--chat-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      padding: 1rem;
      overflow-y: auto;
      padding-bottom: 4rem;
      flex: 1 1 auto;
    }
    .user, .assistant {
      padding: 0.75rem;
      border-radius: var(--radius);
      max-width: 70%;
      margin: 0.5rem 0;
    }
    .user       { background:#e8f6ff; margin-left:auto; }
    .assistant  { background:#f4f4f4; margin-right:auto; }
    /* ----- form ----- */
    #form {
      position: sticky;
      bottom: 0;
      z-index: 1;
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      padding: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-shrink: 0;
    }
    #input {
      flex: 1 1 auto;
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      background: #fff;
      resize: none;
      overflow: hidden;
      line-height: 1.4;
      min-height: calc(1.4em * 1);
      max-height: calc(1.4em * 15);
      font-family: inherit;
    }
    #form button[type="submit"] {
      background: var(--primary);
      color: #fff;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: var(--radius);
    }
    #form button[type="submit"]:hover {
      background: var(--primary-hov);
    }
    /* ----- image previews ----- */
    #imageInput { display:none; }
    #imageLabel {
      padding:0.6rem 1.2rem;
      border-radius:var(--radius);
      background:var(--accent);
      color:#fff;
      cursor:pointer;
      transition:background 0.2s;
    }
    #imageLabel:hover { background:var(--accent-hov); }
    img.chat-preview {
      max-width: 150px;
      max-height: 150px;
      border-radius: var(--radius);
      margin: 0.5rem 0;
      border: 1px solid var(--border-color);
    }
    #image-container {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-top: 1rem;
    }
    /* ---------- Mobile tweaks ---------- */
    @media (max-width: 600px) {
      body { flex-direction: column; }
      #sidebar {
        width: 100%; min-width: 0; max-width: none; flex-direction: row;
        gap:0.5rem; overflow-x:auto; border-right:none; border-bottom:1px solid #ccc;
        padding: 0.75rem 1rem;
      }
      #sidebar h2 { display:none; }
      #modelSelect, #newChatBtn, #clearBtn, #renameBtn { flex: 0 0 auto; }
      #chatList { display:none; }
      #main { padding: 1rem; }
      .user,.assistant{ max-width:100%; }
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <h2>Model control</h2>
    <select id="modelSelect"></select>
    <button id="newChatBtn">‚ûï New chat</button>
    <button id="clearBtn">üóëÔ∏è Clear chat</button>
    <button id="renameBtn">‚úèÔ∏è Rename chat</button>
    <ul id="chatList"></ul>
  </div>

  <div id="main">
    <h1 style="margin-top:0;">Mistral.rs Chat</h1>

    <div id="log"></div>

    <form id="form" autocomplete="off">
      <textarea id="input" placeholder="Type your message‚Ä¶ (Press Ctrl+Enter to send)" rows="1"></textarea>
      <label id="imageLabel" for="imageInput">üìé Image</label>
      <input id="imageInput" type="file" accept="image/*" />
      <button type="submit">Send</button>
    </form>

    <div id="image-container"></div>

    <!-- Markdown renderer -->
    <script src="marked.min.js"></script>
    <script>
      const log          = document.getElementById('log');
      const input        = document.getElementById('input');
      const form         = document.getElementById('form');
      const modelSelect  = document.getElementById('modelSelect');
      const clearBtn     = document.getElementById('clearBtn');
      const newChatBtn   = document.getElementById('newChatBtn');
      const renameBtn    = document.getElementById('renameBtn');
      const chatList     = document.getElementById('chatList');
      const imageInput   = document.getElementById('imageInput');
      const imageLabel   = document.getElementById('imageLabel');
      const mainArea     = document.getElementById('main');
      const ws           = new WebSocket(`ws://${location.host}/ws`);

      // track which chat is currently loaded
      let pendingClear = false;
      let currentChatId = null;
      const CLEAR_CMD = "__CLEAR__";

      const models = Object.create(null); // name ‚Üí kind
      let   prevModel = null;

      function renderMarkdown(src){
        const esc = src.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
        return marked.parse(esc);
      }
      function append(html,cls=''){
        const d=document.createElement('div');
        if(cls) d.className=cls;
        d.innerHTML=html;
        addCopyBtns(d); fixLinks(d);
        log.appendChild(d); log.scrollTop=log.scrollHeight; return d;
      }
      function addCopyBtns(el){
        el.querySelectorAll('pre').forEach(pre=>{
          if(pre.querySelector('.copy-btn')) return;
          const b=document.createElement('button');
          b.textContent='Copy'; b.className='copy-btn';
          b.onclick=()=>{navigator.clipboard.writeText((pre.querySelector('code')||pre).innerText.trim()); b.textContent='‚úî'; setTimeout(()=>b.textContent='Copy',800);};
          pre.appendChild(b);
        });
      }
      function fixLinks(el){ el.querySelectorAll('a[href]').forEach(a=>{a.target='_blank';a.rel='noopener noreferrer';}); }
      function updateImageVisibility(kind){
        imageLabel.style.display = (kind==='vision') ? 'inline-block':'none';
        if(kind!=='vision') imageInput.value='';
      }

      async function refreshChatList(){
        const res = await fetch('/api/list_chats');
        const data = await res.json();
        chatList.innerHTML='';
        data.chats.forEach((c,idx)=>{
          const li=document.createElement('li');
          const display = c.title && c.title.trim() ? c.title : `Chat #${idx+1}`;
          li.textContent = display;
          li.dataset.id  = c.id;
          li.onclick = ()=>loadChat(c.id);
          chatList.appendChild(li);
        });
      }

      async function loadChat(id){
        if(!maybeClearChat(true)) return;
        const res = await fetch('/api/load_chat',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({id})
        });
        if(!res.ok){ alert('Failed to load chat'); return; }
        const data = await res.json();
        currentChatId = data.id;
        if(data.model && models[data.model]){
          modelSelect.value = data.model;
          prevModel = data.model;
          updateImageVisibility(models[data.model]);
        }
        log.innerHTML='';
        data.messages.forEach(m=>{
          append(renderMarkdown(m.content), m.role==='user'?'user':'assistant');
          if(ws.readyState===WebSocket.OPEN){
            ws.send(JSON.stringify({restore:m}));
          }
        });
      }

      async function refreshModels(){
        const res=await fetch('/api/list_models');
        const data=await res.json();
        modelSelect.innerHTML='';
        Object.keys(models).forEach(k=>delete models[k]);
        data.models.forEach(m=>{
          models[m.name]=m.kind;
          const opt=document.createElement('option');
          opt.value=m.name; opt.textContent=(m.kind==='vision'?'üñºÔ∏è ':'üìù ')+m.name;
          modelSelect.appendChild(opt);
        });
        if(modelSelect.options.length){
          modelSelect.selectedIndex=0;
          prevModel=modelSelect.value;
          updateImageVisibility(models[prevModel]);
          await selectModel(prevModel,false);
        }
        await refreshChatList();
      }

      function maybeClearChat(skipConfirm = false){
        if(log.children.length===0) return true;
        if(skipConfirm || confirm('Clear the current draft conversation?')){
          pendingClear = true;
          if(ws.readyState===WebSocket.OPEN) ws.send(CLEAR_CMD);
          log.innerHTML='';
          return true;
        }
        return false;
      }

      async function selectModel(name, notify=true){
        await fetch('/api/select_model',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({name})
        });
      }

      modelSelect.addEventListener('change',async()=>{
        const name=modelSelect.value;
        if(name===prevModel) return;
        if(!maybeClearChat()){ modelSelect.value=prevModel; return; }
        updateImageVisibility(models[name]);
        prevModel=name;
        await selectModel(name);
      });

      newChatBtn.addEventListener('click', async () => {
        if (!prevModel) { alert('Select a model first'); return; }
        const res = await fetch('/api/new_chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ model: prevModel })
        });
        if (!res.ok) { alert('Failed to create new chat'); return; }
        const { id } = await res.json();
        currentChatId = id;
        log.innerHTML = '';
        await refreshChatList();
      });

      clearBtn.addEventListener('click', () => {
        if (log.children.length === 0) return;
        if (!confirm('Clear the chat history?')) return;
        pendingClear = true;
        if (ws.readyState === WebSocket.OPEN) ws.send(CLEAR_CMD);
        log.innerHTML='';
      });

      renameBtn.addEventListener('click', async () => {
        if (!currentChatId) { alert('No chat selected'); return; }
        const newTitle = prompt('Enter new chat name:', '');
        if (newTitle && newTitle.trim()) {
          const res = await fetch('/api/rename_chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: currentChatId, title: newTitle.trim() })
          });
          if (res.ok) {
            await refreshChatList();
          } else {
            alert('Failed to rename chat');
          }
        }
      });

      // textarea auto-resize
      const maxH=parseFloat(getComputedStyle(input).lineHeight)*10;
      function fit(){ input.style.height='auto'; input.style.height=Math.min(input.scrollHeight,maxH)+'px'; }
      input.addEventListener('input',fit); fit();

      // websocket streaming
      let assistantBuf='',assistantDiv=null;
      ws.addEventListener('message',ev=>{
        if(ev.data==='[Context cleared]'){ pendingClear=false; return; }
        if(ev.data==='Cannot clear while assistant is replying.'){ pendingClear=false; alert(ev.data); return; }
        if(!assistantDiv) assistantDiv=append('', 'assistant');
        assistantBuf+=ev.data;
        assistantDiv.innerHTML=renderMarkdown(assistantBuf);
        addCopyBtns(assistantDiv); fixLinks(assistantDiv);
        log.scrollTop=log.scrollHeight;
      });

      // send user messages
      function sendMessage(){
        const msg=input.value.trim();
        if(!msg) return;
        append(renderMarkdown(msg),'user');
        assistantBuf=''; assistantDiv=null;
        ws.send(msg);
        input.value=''; fit();
      }
      form.addEventListener('submit',ev=>{ev.preventDefault();sendMessage();});
      input.addEventListener('keydown',ev=>{
        if(ev.key==='Enter'&&!ev.shiftKey){
          if(ev.ctrlKey||ev.metaKey){ev.preventDefault();sendMessage();}
          else ev.preventDefault();
        }
      });

      // image upload
      imageInput.addEventListener('change',async()=>{
        const f=imageInput.files[0]; if(!f) return;
        const img=document.createElement('img'); img.src=URL.createObjectURL(f); img.classList.add('chat-preview');
        document.getElementById('image-container').appendChild(img);
        const fd=new FormData(); fd.append('image',f);
        const r=await fetch('/api/upload_image',{method:'POST',body:fd});
        if(r.ok&&ws.readyState===WebSocket.OPEN){const j=await r.json();ws.send(JSON.stringify({image:j.url}));}
        imageInput.value='';
      });

      // drag & drop
      mainArea.addEventListener('dragover',e=>{e.preventDefault();mainArea.classList.add('drag-over');});
      mainArea.addEventListener('dragleave',e=>{e.preventDefault();mainArea.classList.remove('drag-over');});
      mainArea.addEventListener('drop',async e=>{
        e.preventDefault(); mainArea.classList.remove('drag-over');
        const f=Array.from(e.dataTransfer.files).find(f=>f.type.startsWith('image/')); if(!f) return;
        const img=document.createElement('img'); img.src=URL.createObjectURL(f); img.classList.add('chat-preview');
        document.getElementById('image-container').appendChild(img);
        const fd=new FormData(); fd.append('image',f);
        const r=await fetch('/api/upload_image',{method:'POST',body:fd});
        if(r.ok&&ws.readyState===WebSocket.OPEN){const j=await r.json();ws.send(JSON.stringify({image:j.url}));}
      });

      refreshModels();
    </script>
  </div><!-- /#main -->
</body>
</html>
