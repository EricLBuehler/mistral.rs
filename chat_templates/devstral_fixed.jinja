{#- Default system message if no system prompt is passed. #}
{%- set default_system_message = '' %}

{#- Begin of sequence token. #}
{{- bos_token }}

{#- Handle system prompt if it exists. #}
{#- System prompt supports text content or text chunks. #}
{%- if messages[0]['role'] == 'system' %}
    {{- '[SYSTEM_PROMPT]' -}}
    {%- if messages[0]['content'] is string %}
        {{- messages[0]['content'] -}}
    {%- else %}        
        {%- for block in messages[0]['content'] %}
            {%- if block['type'] == 'text' %}
                {{- block['text'] }}
            {%- else %}
                {{- raise_exception('Only text chunks are supported in system message contents.') }}
            {%- endif %}
        {%- endfor %}
    {%- endif %}
    {{- '[/SYSTEM_PROMPT]' -}}
    {%- set loop_messages = messages[1:] %}
{%- else %}
    {%- set loop_messages = messages %}
    {%- if default_system_message != '' %}
        {{- '[SYSTEM_PROMPT]' + default_system_message + '[/SYSTEM_PROMPT]' }}
    {%- endif %}
{%- endif %}


{#- Tools definition #}
{%- set tools_definition = '' %}
{%- set has_tools = false %}
{%- if tools is defined and tools is not none and tools|length > 0 %}
    {%- set has_tools = true %}
    {%- set tools_definition = '[AVAILABLE_TOOLS]' + (tools| tojson) + '[/AVAILABLE_TOOLS]' %}
    {{- tools_definition }}
{%- endif %}

{#- Checks for alternating user/assistant messages. #}
{%- set ns = namespace(index=0) %}
{%- for message in loop_messages %}
    {%- if message.role == 'user' or (message.role == 'assistant' and (message.tool_calls is not defined or message.tool_calls is none or message.tool_calls | length == 0)) %}
        {%- if (message['role'] == 'user') != (ns.index % 2 == 0) %}
            {{- raise_exception('After the optional system message, conversation roles must alternate user and assistant roles except for tool calls and results.') }}
        {%- endif %}
        {%- set ns.index = ns.index + 1 %}
    {%- endif %}
{%- endfor %}

{#- Handle conversation messages. #}
{%- for message in loop_messages %}

    {#- User messages supports text content or text and image chunks. #}
    {%- if message['role'] == 'user' %}
        {%- if message['content'] is string %}
            {{- '[INST]' + message['content'] + '[/INST]' }}
        {%- elif message['content'] is defined and message['content'] | length > 0 %}
            {{- '[INST]' }}
            {%- if message['content'] | length == 2 %}
                {%- set blocks = message['content'] | sort(attribute='type') %}
            {%- else %}
                {%- set blocks = message['content'] %}
            {%- endif %}
            {%- for block in blocks %}
                {%- if block['type'] == 'text' %}
                    {{- block['text'] }}
                {%- elif block['type'] in ['image', 'image_url'] %}
                    {{- '[IMG]' }}
                {%- else %}
                    {{- raise_exception('Only text, image and image_url chunks are supported in user message content.') }}
                {%- endif %}
            {%- endfor %}
            {{- '[/INST]' }}
        {%- else %}
            {{- raise_exception('User message must have a string or a list of chunks in content') }}
        {%- endif %}

    {#- Assistant messages supports text content or text and image chunks. #}
    {%- elif message['role'] == 'assistant' %}
        {#- Normalize assistant fields without calling get() (mini-jinja lacks kwargs). #}
        {%- if message.content is defined %}
            {%- set content = message.content %}
        {%- else %}
            {%- set content = none %}
        {%- endif %}
        {%- if message.tool_calls is defined %}
            {%- set tool_calls = message.tool_calls %}
        {%- else %}
            {%- set tool_calls = none %}
        {%- endif %}
        {%- set has_content = (content is string and content|length > 0) or (content is sequence and content is not string and content|length > 0) %}
        {%- set has_tool_calls = tool_calls is sequence and tool_calls|length > 0 %}

        {%- if has_content or has_tool_calls %}
            {%- if content is string %}
                {{- content }}
            {%- elif content is sequence and content is not string and content|length > 0 %}
                {%- for block in content %}
                    {%- if block['type'] == 'text' %}
                        {{- block['text'] }}
                    {%- else %}
                        {{- raise_exception('Only text chunks are supported in assistant message contents.') }}
                    {%- endif %}
                {%- endfor %}
            {%- endif %}
            
            {%- if has_tool_calls %}
                {%- for tool in tool_calls %}
                    {%- if tool.function is defined %}
                        {%- set func = tool.function %}
                    {%- else %}
                        {%- set func = tool['function'] %}
                    {%- endif %}
                    {%- set arguments = '{}' %}
                    {%- if func is mapping and func.arguments is defined %}
                        {%- set arguments = func.arguments %}
                    {%- elif func is mapping and func['arguments'] is defined %}
                        {%- set arguments = func['arguments'] %}
                    {%- endif %}
                    {%- if arguments is not string %}
                        {%- set arguments = arguments|tojson|safe %}
                    {%- elif arguments == '' %}
                        {%- set arguments = '{}' %}
                    {%- endif %}
                    {{- '[TOOL_CALLS]' + func['name'] + '[ARGS]' + arguments }}
                {%- endfor %}
            {%- endif %}

            {#- End of sequence token for each assistant messages. #}
            {{- eos_token }}
        {%- endif %}

    {#- Tool messages only supports text content. #}
    {%- elif message['role'] == 'tool' %}
        {{- '[TOOL_RESULTS]' + message['content']|string + '[/TOOL_RESULTS]' }}

    {#- Raise exception for unsupported roles. #}
    {%- else %}
        {{- raise_exception('Only user, assistant and tool roles are supported, got ' + message['role'] + '.') }}
    {%- endif %}
{%- endfor %}
